#include <string.h>
#include "../include/lamb/runtime.h"
#include "../include/lamb/gc.h"

void runtime_init(void) {
  gc_init();
}

void runtime_exit(void) {
  gc_exit();
}

uintptr_t ACCESS(env_t *env, stack_t *stack, uintptr_t i)
{
  closure_t clos = env->values[env->count - i - 1];
  return clos.code(clos.env.count, clos.env.values, stack->count, stack->values);
}

void GRAB(env_t *env, stack_t *stack)
{
  uintptr_t stack_map = 4;
  closure_t *new_env_values =
    gc_alloc(env->count, env->values, stack->count, stack->values, env->count + 1, sizeof(closure_t), &stack_map);
  memcpy(new_env_values, env->values, env->count * sizeof(closure_t));
  --stack->count;
  closure_t clos = stack->values[stack->count];
  env->values = new_env_values;
  env->values[env->count] = clos;
  ++env->count;
}

void PUSH(env_t *env, stack_t *stack, uintptr_t (*code)(uintptr_t, closure_t *, uintptr_t, closure_t *))
{
  closure_t clos;
  clos.code = code;
  clos.env = *env;

  stack->values[stack->count] = clos;
  ++stack->count;
}

#define LAMB_N_DEF(n, m)                                                    \
  uintptr_t lamb_n ## n (uintptr_t env_count, closure_t *env_values, uintptr_t stack_count, closure_t *stack_values) { \
    env_t env = {env_count, env_values};                                \
    stack_t stack = {stack_count, stack_values};                        \
    GRAB(&env, &stack);                                                 \
    GRAB(&env, &stack);                                                 \
    PUSH(&env, &stack, lamb_n_cont ## m);                               \
    return ACCESS(&env, &stack, 1);                                     \
  }

#define LAMB_N_CONT(n, m)                                               \
  uintptr_t lamb_n_cont ## n (uintptr_t env_count, closure_t *env_values, uintptr_t stack_count, closure_t *stack_values) { \
    env_t env = {env_count, env_values};                                \
    stack_t stack = {stack_count, stack_values};                        \
    PUSH(&env, &stack, lamb_n_cont ## m);                               \
    return ACCESS(&env, &stack, 1);                                     \
  }

uintptr_t lamb_n0(uintptr_t env_count, closure_t *env_values, uintptr_t stack_count, closure_t *stack_values) {
  env_t env = {env_count, env_values};
  stack_t stack = {stack_count, stack_values};
  GRAB(&env, &stack);
  GRAB(&env, &stack);
  return ACCESS(&env, &stack, 0);
}

uintptr_t lamb_n_cont0(uintptr_t env_count, closure_t *env_values, uintptr_t stack_count, closure_t *stack_values) {
  env_t env = {env_count, env_values};
  stack_t stack = {stack_count, stack_values};
  return ACCESS(&env, &stack, 0);
}

LAMB_N_DEF(1, 0) LAMB_N_CONT(1, 0) LAMB_N_DEF(2, 1) LAMB_N_CONT(2, 1) LAMB_N_DEF(3, 2) LAMB_N_CONT(3, 2) LAMB_N_DEF(4, 3) LAMB_N_CONT(4, 3) LAMB_N_DEF(5, 4) LAMB_N_CONT(5, 4) LAMB_N_DEF(6, 5) LAMB_N_CONT(6, 5) LAMB_N_DEF(7, 6) LAMB_N_CONT(7, 6) LAMB_N_DEF(8, 7) LAMB_N_CONT(8, 7) LAMB_N_DEF(9, 8) LAMB_N_CONT(9, 8) LAMB_N_DEF(10, 9) LAMB_N_CONT(10, 9) LAMB_N_DEF(11, 10) LAMB_N_CONT(11, 10) LAMB_N_DEF(12, 11) LAMB_N_CONT(12, 11) LAMB_N_DEF(13, 12) LAMB_N_CONT(13, 12) LAMB_N_DEF(14, 13) LAMB_N_CONT(14, 13) LAMB_N_DEF(15, 14) LAMB_N_CONT(15, 14)
LAMB_N_DEF(16, 15) LAMB_N_CONT(16, 15) LAMB_N_DEF(17, 16) LAMB_N_CONT(17, 16) LAMB_N_DEF(18, 17) LAMB_N_CONT(18, 17) LAMB_N_DEF(19, 18) LAMB_N_CONT(19, 18) LAMB_N_DEF(20, 19) LAMB_N_CONT(20, 19) LAMB_N_DEF(21, 20) LAMB_N_CONT(21, 20) LAMB_N_DEF(22, 21) LAMB_N_CONT(22, 21) LAMB_N_DEF(23, 22) LAMB_N_CONT(23, 22) LAMB_N_DEF(24, 23) LAMB_N_CONT(24, 23) LAMB_N_DEF(25, 24) LAMB_N_CONT(25, 24) LAMB_N_DEF(26, 25) LAMB_N_CONT(26, 25) LAMB_N_DEF(27, 26) LAMB_N_CONT(27, 26) LAMB_N_DEF(28, 27) LAMB_N_CONT(28, 27) LAMB_N_DEF(29, 28) LAMB_N_CONT(29, 28) LAMB_N_DEF(30, 29) LAMB_N_CONT(30, 29) LAMB_N_DEF(31, 30) LAMB_N_CONT(31, 30)
LAMB_N_DEF(32, 31) LAMB_N_CONT(32, 31) LAMB_N_DEF(33, 32) LAMB_N_CONT(33, 32) LAMB_N_DEF(34, 33) LAMB_N_CONT(34, 33) LAMB_N_DEF(35, 34) LAMB_N_CONT(35, 34) LAMB_N_DEF(36, 35) LAMB_N_CONT(36, 35) LAMB_N_DEF(37, 36) LAMB_N_CONT(37, 36) LAMB_N_DEF(38, 37) LAMB_N_CONT(38, 37) LAMB_N_DEF(39, 38) LAMB_N_CONT(39, 38) LAMB_N_DEF(40, 39) LAMB_N_CONT(40, 39) LAMB_N_DEF(41, 40) LAMB_N_CONT(41, 40) LAMB_N_DEF(42, 41) LAMB_N_CONT(42, 41) LAMB_N_DEF(43, 42) LAMB_N_CONT(43, 42) LAMB_N_DEF(44, 43) LAMB_N_CONT(44, 43) LAMB_N_DEF(45, 44) LAMB_N_CONT(45, 44) LAMB_N_DEF(46, 45) LAMB_N_CONT(46, 45) LAMB_N_DEF(47, 46) LAMB_N_CONT(47, 46)
LAMB_N_DEF(48, 47) LAMB_N_CONT(48, 47) LAMB_N_DEF(49, 48) LAMB_N_CONT(49, 48) LAMB_N_DEF(50, 49) LAMB_N_CONT(50, 49) LAMB_N_DEF(51, 50) LAMB_N_CONT(51, 50) LAMB_N_DEF(52, 51) LAMB_N_CONT(52, 51) LAMB_N_DEF(53, 52) LAMB_N_CONT(53, 52) LAMB_N_DEF(54, 53) LAMB_N_CONT(54, 53) LAMB_N_DEF(55, 54) LAMB_N_CONT(55, 54) LAMB_N_DEF(56, 55) LAMB_N_CONT(56, 55) LAMB_N_DEF(57, 56) LAMB_N_CONT(57, 56) LAMB_N_DEF(58, 57) LAMB_N_CONT(58, 57) LAMB_N_DEF(59, 58) LAMB_N_CONT(59, 58) LAMB_N_DEF(60, 59) LAMB_N_CONT(60, 59) LAMB_N_DEF(61, 60) LAMB_N_CONT(61, 60) LAMB_N_DEF(62, 61) LAMB_N_CONT(62, 61) LAMB_N_DEF(63, 62) LAMB_N_CONT(63, 62)
LAMB_N_DEF(64, 63) LAMB_N_CONT(64, 63) LAMB_N_DEF(65, 64) LAMB_N_CONT(65, 64) LAMB_N_DEF(66, 65) LAMB_N_CONT(66, 65) LAMB_N_DEF(67, 66) LAMB_N_CONT(67, 66) LAMB_N_DEF(68, 67) LAMB_N_CONT(68, 67) LAMB_N_DEF(69, 68) LAMB_N_CONT(69, 68) LAMB_N_DEF(70, 69) LAMB_N_CONT(70, 69) LAMB_N_DEF(71, 70) LAMB_N_CONT(71, 70) LAMB_N_DEF(72, 71) LAMB_N_CONT(72, 71) LAMB_N_DEF(73, 72) LAMB_N_CONT(73, 72) LAMB_N_DEF(74, 73) LAMB_N_CONT(74, 73) LAMB_N_DEF(75, 74) LAMB_N_CONT(75, 74) LAMB_N_DEF(76, 75) LAMB_N_CONT(76, 75) LAMB_N_DEF(77, 76) LAMB_N_CONT(77, 76) LAMB_N_DEF(78, 77) LAMB_N_CONT(78, 77) LAMB_N_DEF(79, 78) LAMB_N_CONT(79, 78)
LAMB_N_DEF(80, 79) LAMB_N_CONT(80, 79) LAMB_N_DEF(81, 80) LAMB_N_CONT(81, 80) LAMB_N_DEF(82, 81) LAMB_N_CONT(82, 81) LAMB_N_DEF(83, 82) LAMB_N_CONT(83, 82) LAMB_N_DEF(84, 83) LAMB_N_CONT(84, 83) LAMB_N_DEF(85, 84) LAMB_N_CONT(85, 84) LAMB_N_DEF(86, 85) LAMB_N_CONT(86, 85) LAMB_N_DEF(87, 86) LAMB_N_CONT(87, 86) LAMB_N_DEF(88, 87) LAMB_N_CONT(88, 87) LAMB_N_DEF(89, 88) LAMB_N_CONT(89, 88) LAMB_N_DEF(90, 89) LAMB_N_CONT(90, 89) LAMB_N_DEF(91, 90) LAMB_N_CONT(91, 90) LAMB_N_DEF(92, 91) LAMB_N_CONT(92, 91) LAMB_N_DEF(93, 92) LAMB_N_CONT(93, 92) LAMB_N_DEF(94, 93) LAMB_N_CONT(94, 93) LAMB_N_DEF(95, 94) LAMB_N_CONT(95, 94)
LAMB_N_DEF(96, 95) LAMB_N_CONT(96, 95) LAMB_N_DEF(97, 96) LAMB_N_CONT(97, 96) LAMB_N_DEF(98, 97) LAMB_N_CONT(98, 97) LAMB_N_DEF(99, 98) LAMB_N_CONT(99, 98) LAMB_N_DEF(100, 99) LAMB_N_CONT(100, 99) LAMB_N_DEF(101, 100) LAMB_N_CONT(101, 100) LAMB_N_DEF(102, 101) LAMB_N_CONT(102, 101) LAMB_N_DEF(103, 102) LAMB_N_CONT(103, 102) LAMB_N_DEF(104, 103) LAMB_N_CONT(104, 103) LAMB_N_DEF(105, 104) LAMB_N_CONT(105, 104) LAMB_N_DEF(106, 105) LAMB_N_CONT(106, 105) LAMB_N_DEF(107, 106) LAMB_N_CONT(107, 106) LAMB_N_DEF(108, 107) LAMB_N_CONT(108, 107) LAMB_N_DEF(109, 108) LAMB_N_CONT(109, 108) LAMB_N_DEF(110, 109) LAMB_N_CONT(110, 109) LAMB_N_DEF(111, 110) LAMB_N_CONT(111, 110)
LAMB_N_DEF(112, 111) LAMB_N_CONT(112, 111) LAMB_N_DEF(113, 112) LAMB_N_CONT(113, 112) LAMB_N_DEF(114, 113) LAMB_N_CONT(114, 113) LAMB_N_DEF(115, 114) LAMB_N_CONT(115, 114) LAMB_N_DEF(116, 115) LAMB_N_CONT(116, 115) LAMB_N_DEF(117, 116) LAMB_N_CONT(117, 116) LAMB_N_DEF(118, 117) LAMB_N_CONT(118, 117) LAMB_N_DEF(119, 118) LAMB_N_CONT(119, 118) LAMB_N_DEF(120, 119) LAMB_N_CONT(120, 119) LAMB_N_DEF(121, 120) LAMB_N_CONT(121, 120) LAMB_N_DEF(122, 121) LAMB_N_CONT(122, 121) LAMB_N_DEF(123, 122) LAMB_N_CONT(123, 122) LAMB_N_DEF(124, 123) LAMB_N_CONT(124, 123) LAMB_N_DEF(125, 124) LAMB_N_CONT(125, 124) LAMB_N_DEF(126, 125) LAMB_N_CONT(126, 125) LAMB_N_DEF(127, 126) LAMB_N_CONT(127, 126)
LAMB_N_DEF(128, 127) LAMB_N_CONT(128, 127) LAMB_N_DEF(129, 128) LAMB_N_CONT(129, 128) LAMB_N_DEF(130, 129) LAMB_N_CONT(130, 129) LAMB_N_DEF(131, 130) LAMB_N_CONT(131, 130) LAMB_N_DEF(132, 131) LAMB_N_CONT(132, 131) LAMB_N_DEF(133, 132) LAMB_N_CONT(133, 132) LAMB_N_DEF(134, 133) LAMB_N_CONT(134, 133) LAMB_N_DEF(135, 134) LAMB_N_CONT(135, 134) LAMB_N_DEF(136, 135) LAMB_N_CONT(136, 135) LAMB_N_DEF(137, 136) LAMB_N_CONT(137, 136) LAMB_N_DEF(138, 137) LAMB_N_CONT(138, 137) LAMB_N_DEF(139, 138) LAMB_N_CONT(139, 138) LAMB_N_DEF(140, 139) LAMB_N_CONT(140, 139) LAMB_N_DEF(141, 140) LAMB_N_CONT(141, 140) LAMB_N_DEF(142, 141) LAMB_N_CONT(142, 141) LAMB_N_DEF(143, 142) LAMB_N_CONT(143, 142)
LAMB_N_DEF(144, 143) LAMB_N_CONT(144, 143) LAMB_N_DEF(145, 144) LAMB_N_CONT(145, 144) LAMB_N_DEF(146, 145) LAMB_N_CONT(146, 145) LAMB_N_DEF(147, 146) LAMB_N_CONT(147, 146) LAMB_N_DEF(148, 147) LAMB_N_CONT(148, 147) LAMB_N_DEF(149, 148) LAMB_N_CONT(149, 148) LAMB_N_DEF(150, 149) LAMB_N_CONT(150, 149) LAMB_N_DEF(151, 150) LAMB_N_CONT(151, 150) LAMB_N_DEF(152, 151) LAMB_N_CONT(152, 151) LAMB_N_DEF(153, 152) LAMB_N_CONT(153, 152) LAMB_N_DEF(154, 153) LAMB_N_CONT(154, 153) LAMB_N_DEF(155, 154) LAMB_N_CONT(155, 154) LAMB_N_DEF(156, 155) LAMB_N_CONT(156, 155) LAMB_N_DEF(157, 156) LAMB_N_CONT(157, 156) LAMB_N_DEF(158, 157) LAMB_N_CONT(158, 157) LAMB_N_DEF(159, 158) LAMB_N_CONT(159, 158)
LAMB_N_DEF(160, 159) LAMB_N_CONT(160, 159) LAMB_N_DEF(161, 160) LAMB_N_CONT(161, 160) LAMB_N_DEF(162, 161) LAMB_N_CONT(162, 161) LAMB_N_DEF(163, 162) LAMB_N_CONT(163, 162) LAMB_N_DEF(164, 163) LAMB_N_CONT(164, 163) LAMB_N_DEF(165, 164) LAMB_N_CONT(165, 164) LAMB_N_DEF(166, 165) LAMB_N_CONT(166, 165) LAMB_N_DEF(167, 166) LAMB_N_CONT(167, 166) LAMB_N_DEF(168, 167) LAMB_N_CONT(168, 167) LAMB_N_DEF(169, 168) LAMB_N_CONT(169, 168) LAMB_N_DEF(170, 169) LAMB_N_CONT(170, 169) LAMB_N_DEF(171, 170) LAMB_N_CONT(171, 170) LAMB_N_DEF(172, 171) LAMB_N_CONT(172, 171) LAMB_N_DEF(173, 172) LAMB_N_CONT(173, 172) LAMB_N_DEF(174, 173) LAMB_N_CONT(174, 173) LAMB_N_DEF(175, 174) LAMB_N_CONT(175, 174)
LAMB_N_DEF(176, 175) LAMB_N_CONT(176, 175) LAMB_N_DEF(177, 176) LAMB_N_CONT(177, 176) LAMB_N_DEF(178, 177) LAMB_N_CONT(178, 177) LAMB_N_DEF(179, 178) LAMB_N_CONT(179, 178) LAMB_N_DEF(180, 179) LAMB_N_CONT(180, 179) LAMB_N_DEF(181, 180) LAMB_N_CONT(181, 180) LAMB_N_DEF(182, 181) LAMB_N_CONT(182, 181) LAMB_N_DEF(183, 182) LAMB_N_CONT(183, 182) LAMB_N_DEF(184, 183) LAMB_N_CONT(184, 183) LAMB_N_DEF(185, 184) LAMB_N_CONT(185, 184) LAMB_N_DEF(186, 185) LAMB_N_CONT(186, 185) LAMB_N_DEF(187, 186) LAMB_N_CONT(187, 186) LAMB_N_DEF(188, 187) LAMB_N_CONT(188, 187) LAMB_N_DEF(189, 188) LAMB_N_CONT(189, 188) LAMB_N_DEF(190, 189) LAMB_N_CONT(190, 189) LAMB_N_DEF(191, 190) LAMB_N_CONT(191, 190)
LAMB_N_DEF(192, 191) LAMB_N_CONT(192, 191) LAMB_N_DEF(193, 192) LAMB_N_CONT(193, 192) LAMB_N_DEF(194, 193) LAMB_N_CONT(194, 193) LAMB_N_DEF(195, 194) LAMB_N_CONT(195, 194) LAMB_N_DEF(196, 195) LAMB_N_CONT(196, 195) LAMB_N_DEF(197, 196) LAMB_N_CONT(197, 196) LAMB_N_DEF(198, 197) LAMB_N_CONT(198, 197) LAMB_N_DEF(199, 198) LAMB_N_CONT(199, 198) LAMB_N_DEF(200, 199) LAMB_N_CONT(200, 199) LAMB_N_DEF(201, 200) LAMB_N_CONT(201, 200) LAMB_N_DEF(202, 201) LAMB_N_CONT(202, 201) LAMB_N_DEF(203, 202) LAMB_N_CONT(203, 202) LAMB_N_DEF(204, 203) LAMB_N_CONT(204, 203) LAMB_N_DEF(205, 204) LAMB_N_CONT(205, 204) LAMB_N_DEF(206, 205) LAMB_N_CONT(206, 205) LAMB_N_DEF(207, 206) LAMB_N_CONT(207, 206)
LAMB_N_DEF(208, 207) LAMB_N_CONT(208, 207) LAMB_N_DEF(209, 208) LAMB_N_CONT(209, 208) LAMB_N_DEF(210, 209) LAMB_N_CONT(210, 209) LAMB_N_DEF(211, 210) LAMB_N_CONT(211, 210) LAMB_N_DEF(212, 211) LAMB_N_CONT(212, 211) LAMB_N_DEF(213, 212) LAMB_N_CONT(213, 212) LAMB_N_DEF(214, 213) LAMB_N_CONT(214, 213) LAMB_N_DEF(215, 214) LAMB_N_CONT(215, 214) LAMB_N_DEF(216, 215) LAMB_N_CONT(216, 215) LAMB_N_DEF(217, 216) LAMB_N_CONT(217, 216) LAMB_N_DEF(218, 217) LAMB_N_CONT(218, 217) LAMB_N_DEF(219, 218) LAMB_N_CONT(219, 218) LAMB_N_DEF(220, 219) LAMB_N_CONT(220, 219) LAMB_N_DEF(221, 220) LAMB_N_CONT(221, 220) LAMB_N_DEF(222, 221) LAMB_N_CONT(222, 221) LAMB_N_DEF(223, 222) LAMB_N_CONT(223, 222)
LAMB_N_DEF(224, 223) LAMB_N_CONT(224, 223) LAMB_N_DEF(225, 224) LAMB_N_CONT(225, 224) LAMB_N_DEF(226, 225) LAMB_N_CONT(226, 225) LAMB_N_DEF(227, 226) LAMB_N_CONT(227, 226) LAMB_N_DEF(228, 227) LAMB_N_CONT(228, 227) LAMB_N_DEF(229, 228) LAMB_N_CONT(229, 228) LAMB_N_DEF(230, 229) LAMB_N_CONT(230, 229) LAMB_N_DEF(231, 230) LAMB_N_CONT(231, 230) LAMB_N_DEF(232, 231) LAMB_N_CONT(232, 231) LAMB_N_DEF(233, 232) LAMB_N_CONT(233, 232) LAMB_N_DEF(234, 233) LAMB_N_CONT(234, 233) LAMB_N_DEF(235, 234) LAMB_N_CONT(235, 234) LAMB_N_DEF(236, 235) LAMB_N_CONT(236, 235) LAMB_N_DEF(237, 236) LAMB_N_CONT(237, 236) LAMB_N_DEF(238, 237) LAMB_N_CONT(238, 237) LAMB_N_DEF(239, 238) LAMB_N_CONT(239, 238)
LAMB_N_DEF(240, 239) LAMB_N_CONT(240, 239) LAMB_N_DEF(241, 240) LAMB_N_CONT(241, 240) LAMB_N_DEF(242, 241) LAMB_N_CONT(242, 241) LAMB_N_DEF(243, 242) LAMB_N_CONT(243, 242) LAMB_N_DEF(244, 243) LAMB_N_CONT(244, 243) LAMB_N_DEF(245, 244) LAMB_N_CONT(245, 244) LAMB_N_DEF(246, 245) LAMB_N_CONT(246, 245) LAMB_N_DEF(247, 246) LAMB_N_CONT(247, 246) LAMB_N_DEF(248, 247) LAMB_N_CONT(248, 247) LAMB_N_DEF(249, 248) LAMB_N_CONT(249, 248) LAMB_N_DEF(250, 249) LAMB_N_CONT(250, 249) LAMB_N_DEF(251, 250) LAMB_N_CONT(251, 250) LAMB_N_DEF(252, 251) LAMB_N_CONT(252, 251) LAMB_N_DEF(253, 252) LAMB_N_CONT(253, 252) LAMB_N_DEF(254, 253) LAMB_N_CONT(254, 253) LAMB_N_DEF(255, 254) LAMB_N_CONT(255, 254)
